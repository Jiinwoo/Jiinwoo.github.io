{"componentChunkName":"component---src-templates-post-tsx","path":"/spring-in-action-5-3ch-bug/","result":{"data":{"markdownRemark":{"html":"<p>최근에 스프링 인 액션 5 책을 보고있는데 문제점이 한두개가 아니다. 책 소개글에 이전 버전에 나타난 여러 문제들을 해결했다고\n나와있는데 전혀 그런 것 같지 않다. 가뜩이나 스프링 잘못해서 사서 공부하는데 해결하는데 시간이 더 많이 든다.. ㅠㅠ</p>\n<p>또 예제 리파지토리는 실행해보고 올린것인지 의문이 든다. </p>\n<p>우선 첫 번째로 헤맸던 것은</p>\n<deckgo-highlight-code language=\"java\"  terminal=\"carbon\" >\n          <code slot=\"code\">@Slf4j\n@Controller\n@RequestMapping(&quot;/design&quot;)\n@SessionAttributes(&quot;order&quot;)\npublic class DesignTacoController {\n\n\tprivate final IngredientRepository ingredientRepo;\n\t\n\tprivate TacoRepository tacoRepo;\n\n\t@Autowired\n\tpublic DesignTacoController(\n\t\t\tIngredientRepository ingredientRepo, TacoRepository tacoRepo) {\n\t  this.ingredientRepo = ingredientRepo;\n\t  this.tacoRepo = tacoRepo;\n\t}\n\n\t@GetMapping\n\t  public String showDesignForm(Model model) {\n\t    \n\t\tList&lt;Ingredient&gt; ingredients = new ArrayList&lt;&gt;();\n\t    ingredientRepo.findAll().forEach(i -&gt; ingredients.add(i));\n\n\t    Type[] types = Ingredient.Type.values();\n\t    for (Type type : types) {\n\t      model.addAttribute(type.toString().toLowerCase(),\n\t          filterByType(ingredients, type));\n\t    }\n\n\t    model.addAttribute(&quot;taco&quot;, new Taco());\n\n\t    return &quot;design&quot;;\n\t  }\n\t\n\t  private List&lt;Ingredient&gt; filterByType(\n\t      List&lt;Ingredient&gt; ingredients, Type type) {\n\t    return ingredients\n\t              .stream()\n\t              .filter(x -&gt; x.getType().equals(type))\n\t              .collect(Collectors.toList());\n\t  }\n\n\t  @ModelAttribute(name = &quot;order&quot;)\n\t  public Order order() {\n\t    return new Order();\n\t  }\n\n\t  @ModelAttribute(name = &quot;taco&quot;)\n\t  public Taco taco() {\n\t    return new Taco();\n\t  }\n\n\t  @PostMapping\n\t  public String processDesign(\n\t\t\t  @Valid Taco design, \n\t\t\t  Errors errors, @ModelAttribute Order order) {\n\t\t  if (errors.hasErrors()) {\n\t\t\t return &quot;design&quot;;\n\t\t  }\n\n\t\t  Taco saved = tacoRepo.save(design);\n\t\t  order.addDesign(saved);\n\n\t\t  return &quot;redirect:/orders/current&quot;;\n\t  }\n\n}</code>\n        </deckgo-highlight-code>\n<p><a href=\"https://github.com/Jpub/SpringInAction5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/Jpub/SpringInAction5</a> 원 제작자 측이 아닌 출판사 측에서 만든 리포를 가져왔다. ch3/ch03-jdcb부분이다\n처음에 GET메소드로 thymeleaf페이지를 가져오고 submit form을 하면 재료가 전달되서 POST메소드에서 처리하는 간단한\n컨트롤러이다. </p>\n<p>하지만 POST메소드를 보면 @Valid 를 통해 검증하고 에러가 존재하면 다시 design 페이지를 반환하는데 이 때\n재료 model객체가 사라져 다음과 같이 표시된다.\n<img src=\"https://user-images.githubusercontent.com/23472139/50333580-9e58e480-0527-11e9-801a-c5aa57def341.JPG\">\n우선 이것을 해결하는 방법은 </p>\n<deckgo-highlight-code language=\"java\"  terminal=\"carbon\" >\n          <code slot=\"code\">    @ModelAttribute\n    public void addIngredientToModel(Model model){\n        List&lt;Ingredient&gt; ingredients = new ArrayList&lt;&gt;();\n        ingredientRepo.findAll().forEach(i -&gt; ingredients.add(i));\n\n        Type[] types = Ingredient.Type.values();\n        for (Type type : types) {\n            model.addAttribute(type.toString().toLowerCase(),\n                    filterByType(ingredients, type));\n        }\n    }\n    @GetMapping\n    public String showDesignForm(Model model) {\n        model.addAttribute(&quot;taco&quot;, new Taco());\n        return &quot;design&quot;;\n    }</code>\n        </deckgo-highlight-code>\n<p>다음과 같이 리팩토링 한다. 메소드에 @ModelAttribute를 붙임으로서 GET메소드에만 model에 적용 되지 않고 해당 컨트롤러\n전체에 적용되도록 한다.</p>\n<p>이제 두번째 문제를 보자.</p>\n<deckgo-highlight-code language=\"java\"  terminal=\"carbon\" >\n          <code slot=\"code\">@Repository\npublic class JdbcTacoRepository implements TacoRepository {\n\n\tprivate JdbcTemplate jdbc;\n\n\t  public JdbcTacoRepository(JdbcTemplate jdbc) {\n\t    this.jdbc = jdbc;\n\t  }\n\n\t  @Override\n\t  public Taco save(Taco taco) {\n\t    long tacoId = saveTacoInfo(taco);\n\t    taco.setId(tacoId);\n\t    \n\t    // 스프링 Converter를 우리가 구현한 IngredientByIdConverter의 Convert() 메서드가 이때 자동 실행된다.\n\t    for (Ingredient ingredient : taco.getIngredients()) { \n\t      saveIngredientToTaco(ingredient, tacoId);\n\t    }\n\n\t    return taco;\n\t  }\n\n\t  private long saveTacoInfo(Taco taco) {\n\t    taco.setCreatedAt(new Date());\n\t    PreparedStatementCreator psc =\n\t        new PreparedStatementCreatorFactory(\n\t            &quot;insert into Taco (name, createdAt) values (?, ?)&quot;,\n\t            Types.VARCHAR, Types.TIMESTAMP\n\t        ).newPreparedStatementCreator(\n\t           Arrays.asList(\n\t               taco.getName(),\n\t               new Timestamp(taco.getCreatedAt().getTime())));\n\n\t    KeyHolder keyHolder = new GeneratedKeyHolder();\n\t    jdbc.update(psc, keyHolder);\n\n\t    return keyHolder.getKey().longValue();\n\t  }\n\n\t  private void saveIngredientToTaco(\n\t          Ingredient ingredient, long tacoId) {\n\t    jdbc.update(\n\t        &quot;insert into Taco_Ingredients (taco, ingredient) &quot; +\n\t        &quot;values (?, ?)&quot;,\n\t        tacoId, ingredient.getId());\n\t  }\n\n}</code>\n        </deckgo-highlight-code>\n<p>위 코드를 보면 IDE 에서 다음과 같이 알려준다\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bccb03b5acd2bebdffae981dda6036b1/4e6ec/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABSklEQVQoz42P226bUBBF+ZlWiXHV2IC52CTENpyD4XBNYmwpUf//J1bnEEeK1Jc+LO0ZzWjPHsdbrVj7GyHgYeXxlO04nw3H4zNRFBEnMXEsGt/U9klCKLMwCgnDDVmWsc8Lng85znJxx8OvBevfrugdabplOL/Tv10ZpnfGy4foJ+PlDy/XD96miWEcaboBM06Y/pW27zFti5NuEx7ThCSWa5uAXZqiuwuqm4QredWiLHVLXhoO6sRRleRadKYWKoqymnvH823sgHLv0WmfSmdU3Qv1jarpaQdJML6i60ZMa4qTmfWLQrCH9kUpLy+XrNYej9uAptyh1AHTjZxMNy+qyqDEoLihquYftGBT7guN47ou1vR+4fLj5z1+EHGSVKW8qG+UYj7zVX+bzXPhM6EY+sFGTAKser7P7ilDi2EuF+3S/2LftSn/AouT/GUAQje8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/bccb03b5acd2bebdffae981dda6036b1/fcda8/1.png\"\n        srcset=\"/static/bccb03b5acd2bebdffae981dda6036b1/12f09/1.png 148w,\n/static/bccb03b5acd2bebdffae981dda6036b1/e4a3f/1.png 295w,\n/static/bccb03b5acd2bebdffae981dda6036b1/fcda8/1.png 590w,\n/static/bccb03b5acd2bebdffae981dda6036b1/4e6ec/1.png 827w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n에엥 난 책에있는대로 했는데 NPE가 발생한다고? 물론 출판사 깃헙 리포에도 똑같다.\n에러를 검색해보니 </p>\n<deckgo-highlight-code language=\"java\"  terminal=\"carbon\" >\n          <code slot=\"code\">    private long saveTacoInfo(Taco taco) {\n        taco.setCreatedAt(LocalDateTime.now());\n        PreparedStatementCreatorFactory pscf = new PreparedStatementCreatorFactory(\n                &quot;Insert into Taco(name, createdAt) values(?,?)&quot;, Types.VARCHAR, Types.TIMESTAMP);\n        pscf.setReturnGeneratedKeys(Boolean.TRUE); // 추가\n        PreparedStatementCreator psc = pscf.newPreparedStatementCreator(\n                Arrays.asList(taco.getName(), Timestamp.valueOf(taco.getCreatedAt())));\n        KeyHolder keyHolder = new GeneratedKeyHolder();\n        jdbc.update(psc, keyHolder);\n        return keyHolder.getKey().longValue();\n    }</code>\n        </deckgo-highlight-code>\n<p>다음과 같이 하면 된다.</p>\n<p>아직 책 초반인데 시간을 너무많이 잡아먹는 것 같다. 힘들다.</p>","excerpt":"최근에 스프링 인 액션…","tableOfContents":"","fields":{"slug":"/spring-in-action-5-3ch-bug/"},"frontmatter":{"title":"Spring in Action 5판 3챕터 에러","date":"Jun 10, 2020","tags":["Spring in action","JDBCTemplate"],"keywords":[null],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/spring-in-action-5-3ch-bug/","series":[],"lastmod":"0001-01-01"}},"staticQueryHashes":["3649515864","63159454"]}